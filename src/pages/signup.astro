---
import PageLayout from "@layouts/PageLayout.astro";
import { getLangFromUrl, useTranslations } from "@/i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const seo = {
	title: "Sign Up - Fishing Notebook",
	description: "Create your Fishing Notebook account",
	noindex: true,
};
---

<PageLayout seo={seo}>
	<section class="min-h-screen flex items-center justify-center bg-gray-50 px-4 py-12">
		<div class="max-w-md w-full bg-white rounded-lg shadow-lg p-8">
			<h1 class="text-3xl font-bold text-gray-900 mb-6 text-center">Εγγραφή</h1>

			<form id="signup-form" class="space-y-6">
				<div>
					<label for="name" class="block text-sm font-medium text-gray-700 mb-2">
						Όνομα
					</label>
					<input
						type="text"
						id="name"
						name="name"
						required
						minlength="2"
						class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
					/>
				</div>

				<div>
					<label for="email" class="block text-sm font-medium text-gray-700 mb-2">
						Email
					</label>
					<input
						type="email"
						id="email"
						name="email"
						required
						class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
					/>
				</div>

				<div>
					<label for="password" class="block text-sm font-medium text-gray-700 mb-2">
						Κωδικός (τουλάχιστον 8 χαρακτήρες)
					</label>
					<input
						type="password"
						id="password"
						name="password"
						required
						minlength="8"
						class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
					/>
				</div>

				<div id="error-message" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
				</div>

				<div id="success-message" class="hidden bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg">
					Επιτυχής εγγραφή! Ανακατεύθυνση...
				</div>

				<button
					type="submit"
					id="submit-btn"
					class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
				>
					Εγγραφή
				</button>
			</form>

			<p class="mt-6 text-center text-sm text-gray-600">
				Έχετε ήδη λογαριασμό;
				<a href="/signin" class="text-blue-600 hover:text-blue-800 font-medium">
					Σύνδεση
				</a>
			</p>
		</div>
	</section>
</PageLayout>

<script>
	import { actions } from "astro:actions";

	const form = document.getElementById("signup-form") as HTMLFormElement;
	const submitBtn = document.getElementById("submit-btn") as HTMLButtonElement;
	const errorMessage = document.getElementById("error-message") as HTMLDivElement;
	const successMessage = document.getElementById("success-message") as HTMLDivElement;

	form.addEventListener("submit", async (e) => {
		e.preventDefault();

		// Hide previous messages
		errorMessage.classList.add("hidden");
		successMessage.classList.add("hidden");

		// Disable button and show loading
		submitBtn.disabled = true;
		submitBtn.textContent = "Φόρτωση...";

		try {
			const formData = new FormData(form);
			const { data, error } = await actions.signUp(formData);

			if (error) {
				throw new Error(error.message);
			}

			// Show success message
			successMessage.classList.remove("hidden");

			// Redirect to dashboard or signin after 1.5 seconds
			setTimeout(() => {
				window.location.href = "/dashboard";
			}, 1500);

		} catch (error: any) {
			// Show error message
			errorMessage.textContent = error.message || "Σφάλμα κατά την εγγραφή";
			errorMessage.classList.remove("hidden");

			// Re-enable button
			submitBtn.disabled = false;
			submitBtn.textContent = "Εγγραφή";
		}
	});
</script>
