---
import PageLayout from "@layouts/PageLayout.astro";
import { getLangFromUrl, useTranslations } from "@i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const seo = {
	title: "Sign Up - Fishing Notebook",
	description: "Create your Fishing Notebook account",
	noindex: true,
};
---

<PageLayout seo={seo}>
	<section class="flex min-h-screen items-center justify-center bg-gray-50 px-4 py-12">
		<div class="w-full max-w-md rounded-lg bg-white p-8 shadow-lg">
			<h1 class="mb-6 text-center text-3xl font-bold text-gray-900">Εγγραφή</h1>

			<form id="signup-form" class="space-y-6">
				<div>
					<label for="name" class="mb-2 block text-sm font-medium text-gray-700">Όνομα</label>
					<input
						type="text"
						id="name"
						name="name"
						required
						minlength="2"
						class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-transparent focus:ring-2 focus:ring-blue-500"
					/>
				</div>

				<div>
					<label for="email" class="mb-2 block text-sm font-medium text-gray-700">Email</label>
					<input
						type="email"
						id="email"
						name="email"
						required
						class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-transparent focus:ring-2 focus:ring-blue-500"
					/>
				</div>

				<div>
					<label for="password" class="mb-2 block text-sm font-medium text-gray-700">
						Κωδικός (τουλάχιστον 8 χαρακτήρες)
					</label>
					<input
						type="password"
						id="password"
						name="password"
						required
						minlength="8"
						class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-transparent focus:ring-2 focus:ring-blue-500"
					/>
				</div>

				<div
					id="error-message"
					class="hidden rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-red-700">
				</div>

				<div
					id="success-message"
					class="hidden rounded-lg border border-green-200 bg-green-50 px-4 py-3 text-green-700">
					Επιτυχής εγγραφή! Ανακατεύθυνση...
				</div>

				<button
					type="submit"
					id="submit-btn"
					class="w-full rounded-lg bg-blue-600 py-3 font-semibold text-white transition-colors hover:bg-blue-700 disabled:cursor-not-allowed disabled:bg-gray-400">
					Εγγραφή
				</button>
			</form>

			<p class="mt-6 text-center text-sm text-gray-600">
				Έχετε ήδη λογαριασμό;
				<a href="/signin" class="font-medium text-blue-600 hover:text-blue-800">Σύνδεση</a>
			</p>
		</div>
	</section>
</PageLayout>

<script>
	import { actions } from "astro:actions";

	const form = document.getElementById("signup-form") as HTMLFormElement;
	const submitBtn = document.getElementById("submit-btn") as HTMLButtonElement;
	const errorMessage = document.getElementById("error-message") as HTMLDivElement;
	const successMessage = document.getElementById("success-message") as HTMLDivElement;

	form.addEventListener("submit", async e => {
		e.preventDefault();

		// Hide previous messages
		errorMessage.classList.add("hidden");
		successMessage.classList.add("hidden");

		// Disable button and show loading
		submitBtn.disabled = true;
		submitBtn.textContent = "Φόρτωση...";

		try {
			const formData = new FormData(form);
			const { data, error } = await actions.signUp(formData);

			if (error) {
				throw new Error(error.message);
			}

			// Show success message
			successMessage.classList.remove("hidden");

			// Redirect to dashboard or signin after 1.5 seconds
			setTimeout(() => {
				window.location.href = "/dashboard";
			}, 1500);
		} catch (error: any) {
			// Show error message
			errorMessage.textContent = error.message || "Σφάλμα κατά την εγγραφή";
			errorMessage.classList.remove("hidden");

			// Re-enable button
			submitBtn.disabled = false;
			submitBtn.textContent = "Εγγραφή";
		}
	});
</script>
