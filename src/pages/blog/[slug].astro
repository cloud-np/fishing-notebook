---
import Container from "@components/containers/Container.astro";
import { Helpers } from "../../utils/helpers";
import Header from "../../components/layout/Header.astro";
import SharePost from "@components/post/SharePost.astro";
import { Picture } from "astro:assets";
import { getPosts, type Post } from "../../libs/post";
import {type CollectionEntry, render} from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getLangFromUrl, useTranslations } from "../../i18n/utils";
import Footer from "@components/layout/Footer.astro";
import InstagramPreview from "@components/common/InstagramPreview.astro";

export async function getStaticPaths() {
	const allPosts = await getPosts(undefined);
	const posts: Post[] = allPosts.filter(post => !post.data.personal);

	// map through the categories array
	return posts.map(post => ({
		params: { slug: post.slug },
		props: { post },
	}));
}

const { post } = Astro.props;
const { Content } = await render(post as CollectionEntry<'blog'>);

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const seo = {
	title: post.data.title,
	description: `${post.data.title} - ${t('settings.description')}`,
	image: post.data.titleImage.src,
	section: "article",
	publishedTime: post.data.publishedAt.toISOString(),
	modifiedTime: post.data.publishedAt.toISOString(),
	tags: [post.data.category, ...post.data.searchCategories],
	keywords: `${post.data.category}, ${post.data.searchCategories.join(', ')}, ανακαίνιση σπιτιού, αρχιτεκτονική`
};
---

<BaseLayout seo={seo} isLightTheme={true}>
	<Header slot="header" />
	<Container>
		<article class="post-content__article">
			<div class="post-content__top fade-in">
				{post.data.category && (
					<p class="post-content__category">
						{post.data.category}
						{/* <a href={`/erga/kathgoria/${Helpers.slugify(post.data.category)}`}>
							{post.data.category}
						</a> */}
					</p>
				)}
				<h1 class="post-content__title">{post.data.title}</h1>
				<p class="post-content__date">
					<time>{Helpers.formatDate(post.data.publishedAt)}</time>
				</p>
				{post.data.author && (
					<p class="post-content__author">
						<span>{post.data.author}</span>
					</p>
				)}
				<p class="post-content__minsread">
					<span>{post.minutesRead} read</span>
				</p>

				{post.data.titleImage && (
					<Picture
						src={post.data.titleImage}
						alt={`Featured for ${post.data.title}`}
						formats={["webp", "png"]}
						class="post-content__img"
						loading="eager"
						width={post.data.titleImage.width}
						height={post.data.titleImage.height}
					/>
				)}
			</div>
			<div class="post-content__content flow fade-in">
				<Content />
			</div>
		</article>
		<SharePost postTitle={post.data.title} />
	</Container>
	<InstagramPreview />
	<Footer slot="footer" />
</BaseLayout>

<style is:global>
	.post-content__top {
		display: flex;
		flex-direction: column;
		align-items: center;
		text-align: center;
	}

	.post-content__category {
		padding: 0.5rem 1rem;
		border-radius: 2rem;
		color: white;
		background-color: #CCA072;
		transition: opacity ease-out .3s;
	}

	.post-content__category a {
		text-decoration: none;
	}

	.post-content__category:hover {
		opacity: 0.8;
	}

	.post-content__article {
		padding-top: 5vh;
	}

	.post-content__title {
		margin: 1rem auto;
		max-width: 100%;
		font-size: var(--step-4);
	}

	.post-content__date {
		margin: 0 auto;
		font-size: var(--step--1);
		color: var(--c-light-gray);
	}

	.post-content__author {
		margin: 0.5rem auto 0 auto;
		font-weight: 600;
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 0.5rem;
	}

	.post-content__author svg {
		width: 1.2rem;
		height: 1.2rem;
	}

	.post-content__minsread {
		font-size: var(--step--2);
		color: var(--c-medium-gray);
	}

	.post-content__img {
		margin: 3rem 0 2rem 0;
		height: auto;
		border-radius: 0.5rem;
	}

	.post-content__content {
		font-size: var(--step--1);
		hyphens: auto;
		max-width: 42.875rem;
		display: flex;
		-webkit-box-pack: center;
		justify-content: center;
		flex-direction: column;
		margin: auto;
		line-height: 1.5;
		text-wrap: pretty;
		word-break: auto-phrase;
	}

	/* Header Styling */
	.post-content__content h1,
	.post-content__content h2,
	.post-content__content h3,
	.post-content__content h4,
	.post-content__content h5,
	.post-content__content h6 {
		margin-top: 2.5rem;
		margin-bottom: 1rem;
		font-weight: 700;
		line-height: 1.2;
	}

	.post-content__content h1 {
		font-size: var(--step-4);
		padding-bottom: 0.5rem;
		margin-bottom: 1.5rem;
	}

	.post-content__content h2 {
		font-size: var(--step-2);
		padding-left: 1rem;
		margin-left: -1rem;
	}

	.post-content__content h3 {
		font-size: var(--step-1);
		color: var(--c-tertiary, #2f2f2f);
		position: relative;
	}

	.post-content__content h4,
	.post-content__content h5,
	.post-content__content h6 {
		font-size: var(--step-0);
	}

	/* List Styling */
	.post-content__content ul {
		margin: 1.5rem 0;
		padding-left: 2rem;
	}

	.post-content__content ul {
		@apply list-none;
	}

	.post-content__content ul li {
		position: relative;
		margin-bottom: 0.75rem;
		padding-left: 1.5rem;
		line-height: 1.6;
	}

	.post-content__content ul li::before {
		content: "◦";
		color: var(--c-accent, #f1a63e);
		font-weight: bold;
		position: absolute;
		left: 0;
		top: 0;
	}

	/* Paragraph spacing after headers */
	.post-content__content h1 + p,
	.post-content__content h2 + p,
	.post-content__content h3 + p,
	.post-content__content h4 + p,
	.post-content__content h5 + p,
	.post-content__content h6 + p {
		margin-top: 0.5rem;
	}

	.post-content__content img {
		display: block;
		margin: 2rem auto;
		object-fit: contain;
		max-width: 100%;
		border-radius: 0.5rem;
	}

	/* TODO: Change all medias to vars */
	@media (max-width: 640px) {
		.post-content__title {
			font-size: var(--step-3);
		}
	}
</style>
